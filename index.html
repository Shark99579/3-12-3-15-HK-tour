<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HK Travel Plan ‚úàÔ∏è</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS (Âú∞Âúñ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SortableJS (ÊãñÊõ≥ÊéíÂ∫è) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2DD4BF', // ÊπñÊ∞¥Á∂† Teal-400
                        secondary: '#F0FDFA', // Ê∑∫ÊπñÊ∞¥Á∂†ËÉåÊôØ
                        accent: '#F43F5E',   // ÈªûÁ∂¥Ëâ≤ (Rose)
                        dark: '#334155',
                        'card-bg': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['"Poppins"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ÊâãÊ©üÊ®°Êì¨Ê°Ü (Ê°åÈù¢ÁâàÊôÇÈ°ØÁ§∫) */
        @media (min-width: 640px) {
            body { display: flex; justify-content: center; min-height: 100vh; align-items: center; padding: 20px; background-image: linear-gradient(135deg, #e0f2fe 0%, #f0fdfa 100%); }
            #app { width: 100%; max-width: 430px; height: 880px; max-height: 92vh; border-radius: 40px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 8px solid #fff; }
        }

        /* ÂãïÁï´ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Ë°åÁ®ãÂç°ÁâáÂ∑¶ÂÅ¥Á∑öÊ¢ù */
        .timeline-line { position: absolute; left: 24px; top: 40px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
        .last-item .timeline-line { display: none; }

        /* ÊãñÊõ≥ÊôÇÁöÑÊ®£Âºè */
        .sortable-ghost { opacity: 0.4; background: #f0f9ff; border: 2px dashed #2DD4BF; }
        .drag-handle { cursor: move; touch-action: none; }

        /* Âú∞Âúñ Popup */
        .leaflet-popup-content-wrapper { border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 0; }
        .leaflet-popup-content { margin: 12px 16px; font-family: 'Noto Sans TC'; font-size: 14px; font-weight: 500; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-full bg-slate-50 relative group">
    
    <!-- È†ÇÈÉ®ÁãÄÊÖãÂàóËàáÂ∞ÅÈù¢ (Ë°åÁ®ãÈ†ÅÈù¢Â∞àÁî® - Á¥îËâ≤Áâà) -->
    <div v-if="currentTab === 'itinerary'" class="relative h-56 w-full shrink-0 overflow-hidden rounded-b-[3rem] shadow-soft z-10 bg-gradient-to-br from-teal-400 to-teal-600">
        <!-- Ë£ùÈ£æÂúìÂúà -->
        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        <div class="absolute top-20 -left-10 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>

        <div class="absolute top-0 w-full p-6 pt-12 flex justify-between items-start text-white">
            <div>
                <div class="flex items-center gap-2 opacity-90 mb-1">
                    <span class="text-xs font-medium tracking-widest uppercase bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm">ID: {{ tripId.substring(0,6) }}</span>
                    <button @click="copyLink" class="bg-white/20 hover:bg-white/40 p-1.5 rounded-full backdrop-blur-md transition">
                        <i class="fas fa-share-alt text-xs"></i>
                    </button>
                    
                    <!-- ÂÑ≤Â≠òÁãÄÊÖãÊåáÁ§∫Ááà (Ë°åÁ®ãÈ†Å) -->
                    <span v-if="syncStatus === 'syncing'" class="text-[10px] font-bold bg-yellow-400/90 text-black px-2 py-0.5 rounded backdrop-blur-sm shadow-sm transition-all">
                        <i class="fas fa-sync fa-spin mr-1"></i>ÂÑ≤Â≠ò‰∏≠...
                    </span>
                    <span v-else-if="syncStatus === 'done'" class="text-[10px] font-bold bg-white/20 text-white px-2 py-0.5 rounded backdrop-blur-sm shadow-sm transition-all">
                        <i class="fas fa-check mr-1"></i>Â∑≤ÂÑ≤Â≠ò ({{ saveModeText }})
                    </span>
                </div>
                <h1 class="text-3xl font-bold drop-shadow-sm">Hong Kong</h1>
            </div>
            <div class="flex flex-col items-end">
                <div class="bg-white/20 backdrop-blur-md rounded-2xl p-2.5 flex flex-col items-center text-white shadow-lg border border-white/20">
                    <i v-if="weather.icon" :class="[weather.icon, 'text-2xl mb-1 drop-shadow-sm']"></i>
                    <span class="text-sm font-bold">{{ weather.temp ? weather.temp + '¬∞' : '--' }}</span>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-0 w-full px-6">
            <div class="flex space-x-3 overflow-x-auto pb-4 pt-2 hide-scrollbar snap-x items-end">
                <!-- Êó•ÊúüÂç°Áâá (ÊîπÁî® div ÂåÖË£π‰ª•ËôïÁêÜÁõ∏Â∞çÂÆö‰Ωç) -->
                <div v-for="(day, index) in tripDays" :key="index" class="snap-center shrink-0 relative group">
                    <button @click="activeDay = index" class="outline-none block">
                        <div :class="['px-4 py-2 rounded-2xl flex flex-col items-center min-w-[64px] transition-all duration-300 border', 
                            activeDay === index ? 'bg-white text-teal-600 shadow-lg scale-105 border-white' : 'bg-white/20 text-white border-white/10 hover:bg-white/30 backdrop-blur-md']">
                            <span class="text-[10px] font-bold tracking-wide uppercase opacity-90">Day</span>
                            <span class="text-xl font-bold">{{ index + 1 }}</span>
                        </div>
                    </button>
                    
                    <!-- Âà™Èô§Â§©Êï∏ÊåâÈàï (ÂÉÖÂú®Á∏ΩÂ§©Êï∏ > 1 ÊôÇÈ°ØÁ§∫) -->
                    <button v-if="tripDays.length > 1" 
                            @click.stop="removeDay(index)"
                            class="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-md hover:bg-red-600 hover:scale-110 transition-all z-20"
                            title="Âà™Èô§Ê≠§Êó•">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Êñ∞Â¢ûÂ§©Êï∏ÊåâÈàï -->
                <button @click="addDay" class="snap-center shrink-0 px-4 py-2 mb-0.5 rounded-2xl bg-white/90 text-teal-600 border-2 border-white/50 flex items-center justify-center min-w-[64px] shadow-lg shadow-black/10 hover:scale-105 transition-all duration-300 group">
                    <i class="fas fa-plus text-xl group-hover:rotate-90 transition-transform duration-300"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- È†ÇÈÉ®Ê®ôÈ°å (ÂÖ∂‰ªñÂàÜÈ†ÅÁî®) -->
    <div v-else class="pt-12 pb-6 px-6 bg-white rounded-b-[2rem] shadow-sm z-10 shrink-0">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-dark">{{ currentTabName }}</h1>
                <!-- ÂÑ≤Â≠òÁãÄÊÖãÊåáÁ§∫ (ÈÄöÁî®È†ÅÈù¢) -->
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-slate-400 text-xs">ID: {{ tripId.substring(0,6) }}</span>
                    <span v-if="syncStatus === 'syncing'" class="text-xs font-bold text-yellow-500 bg-yellow-50 px-2 py-0.5 rounded-full"><i class="fas fa-circle-notch fa-spin mr-1"></i>ÂÑ≤Â≠ò‰∏≠...</span>
                    <span v-else-if="syncStatus === 'done'" class="text-xs font-bold text-green-500 bg-green-50 px-2 py-0.5 rounded-full"><i class="fas fa-check-circle mr-1"></i>Â∑≤ÂÑ≤Â≠ò ({{ saveModeText }})</span>
                    <span v-else class="text-slate-300 text-xs">‚Ä¢ ÂæÖÊ©ü‰∏≠</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
    <main class="flex-1 overflow-y-auto hide-scrollbar relative bg-slate-50">
        
        <!-- Tab 1: Ë°åÁ®ãË°® -->
        <div v-if="currentTab === 'itinerary'" class="px-5 pt-6 pb-28 space-y-4">
            
            <div v-if="!tripDays[activeDay]" class="text-center py-10 text-slate-400">ËºâÂÖ•‰∏≠...</div>
            <div v-else-if="tripDays[activeDay].events.length === 0" class="text-center py-12">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300 text-2xl">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <p class="text-slate-400 text-sm">ÈÄôÂ§©ÈÇÑÊ≤íÊúâË®àÁï´Âñî</p>
                <div class="flex gap-2 justify-center mt-4">
                     <button @click="addEvent" class="px-5 py-2 bg-primary text-white rounded-full text-sm font-bold shadow-lg shadow-primary/30">Êñ∞Â¢ûË°åÁ®ã</button>
                     <button @click="addFlight" class="px-5 py-2 bg-white text-primary border border-primary rounded-full text-sm font-bold shadow-sm">Êñ∞Â¢ûËà™Áè≠</button>
                </div>
            </div>

            <!-- ÊãñÊõ≥ÂÆπÂô® Sortable Container -->
            <div ref="eventListRef" class="space-y-4 pb-2">
                <div v-for="(event, idx) in tripDays[activeDay]?.events" :key="event.id || idx" 
                     :class="['relative transition-all duration-300', event.type === 'flight' ? 'pl-2' : 'pl-14 last-item-check']">
                    
                    <!-- Â∑¶ÂÅ¥ÊôÇÈñìËª∏ (ÂÉÖ‰∏ÄËà¨Ë°åÁ®ãÈ°ØÁ§∫) -->
                    <div v-if="event.type !== 'flight'" class="absolute left-0 top-0 w-12 flex flex-col items-center z-10 pointer-events-none">
                        <span class="text-xs font-bold text-slate-400 mb-1">{{ event.time }}</span>
                        <div class="w-3 h-3 rounded-full bg-primary border-2 border-white ring-2 ring-slate-100"></div>
                    </div>
                    <div v-if="event.type !== 'flight'" class="timeline-line"></div>

                    <!-- Âç°ÁâáÊú¨È´î -->
                    <div :class="['rounded-3xl shadow-soft border group relative', 
                        event.type === 'flight' ? 'bg-white border-blue-100 p-0 overflow-hidden' : 'bg-white border-slate-100 p-5']">
                        
                        <!-- ÊãñÊõ≥ÊääÊâã -->
                        <div class="drag-handle absolute right-3 top-3 text-slate-300 p-2 hover:text-slate-500 z-20">
                            <i class="fas fa-bars"></i>
                        </div>

                        <!-- Á∑®ËºØÊ®°Âºè -->
                        <div v-if="event.isEditing" class="p-4 space-y-3">
                            <div class="flex justify-between items-center text-xs font-bold uppercase tracking-wide">
                                <span :class="event.type==='flight'?'text-blue-500':'text-primary'">{{ event.type === 'flight' ? 'Flight Details' : 'Event Details' }}</span>
                                <button @click="removeEvent(idx)" class="text-slate-300 hover:text-red-400 px-2 py-1"><i class="fas fa-trash"></i></button>
                            </div>

                            <!-- Ëà™Áè≠Á∑®ËºØÊ¨Ñ‰Ωç -->
                            <div v-if="event.type === 'flight'" class="space-y-3">
                                <input v-model="event.title" placeholder="Ëà™Áè≠‰ª£Ëôü (‰æã: CX450)" class="w-full bg-slate-50 p-3 rounded-xl font-bold text-dark outline-none focus:ring-1 focus:ring-blue-400">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 space-y-1">
                                        <label class="text-[10px] text-slate-400 font-bold uppercase">Ëµ∑È£õ DEPARTURE</label>
                                        <input v-model="event.depCode" @input="event.depCode = $event.target.value.toUpperCase()" placeholder="TPE" class="w-full bg-slate-50 p-2 rounded-lg text-sm font-bold uppercase text-center outline-none">
                                        <input v-model="event.depTime" type="time" class="w-full bg-slate-50 p-2 rounded-lg text-xs text-center outline-none">
                                    </div>
                                    <i class="fas fa-plane text-blue-300"></i>
                                    <div class="flex-1 space-y-1">
                                        <label class="text-[10px] text-slate-400 font-bold uppercase">ÈôçËêΩ ARRIVAL</label>
                                        <input v-model="event.arrCode" @input="event.arrCode = $event.target.value.toUpperCase()" placeholder="HKG" class="w-full bg-slate-50 p-2 rounded-lg text-sm font-bold uppercase text-center outline-none">
                                        <input v-model="event.arrTime" type="time" class="w-full bg-slate-50 p-2 rounded-lg text-xs text-center outline-none">
                                    </div>
                                </div>
                            </div>

                            <!-- ‰∏ÄËà¨Ë°åÁ®ãÁ∑®ËºØÊ¨Ñ‰Ωç -->
                            <div v-else class="space-y-3">
                                <input v-model="event.time" type="time" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-primary/20">
                                <input v-model="event.title" placeholder="Âú∞ÈªûÂêçÁ®±" class="w-full bg-slate-50 p-3 rounded-xl font-bold text-dark outline-none focus:ring-2 focus:ring-primary/20">
                                <input v-model="event.note" placeholder="ÂÇôË®ª" class="w-full bg-slate-50 p-3 rounded-xl text-sm text-slate-500 outline-none focus:ring-2 focus:ring-primary/20">
                            </div>

                            <button @click="event.isEditing = false; updateData()" :class="['w-full text-white py-3 rounded-xl font-bold text-sm shadow-md', event.type==='flight'?'bg-blue-500 shadow-blue-500/20':'bg-primary shadow-primary/20']">ÂÆåÊàê</button>
                        </div>

                        <!-- È°ØÁ§∫Ê®°Âºè -->
                        <div v-else @click="event.isEditing = true" class="cursor-pointer">
                            
                            <!-- Ëà™Áè≠È°ØÁ§∫ -->
                            <div v-if="event.type === 'flight'" class="flex flex-col">
                                <div class="bg-blue-500 p-3 flex justify-between items-center text-white">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-plane-departure"></i>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold tracking-wider">{{ event.title || 'FLIGHT' }}</span>
                                            <!-- Ê®ôÈ°åÊ¨ÑÈ°ØÁ§∫Ëµ∑ÈôçÊ©üÂ†¥ -->
                                            <span v-if="event.depCode && event.arrCode" class="bg-blue-600/50 px-2 py-0.5 rounded text-xs font-mono">
                                                {{ event.depCode }} <i class="fas fa-arrow-right text-[10px] mx-1"></i> {{ event.arrCode }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 flex justify-between items-center relative">
                                    <!-- ËôõÁ∑öË£ùÈ£æ -->
                                    <div class="absolute top-1/2 left-4 right-4 h-0.5 border-t-2 border-dashed border-slate-200 -z-1"></div>
                                    
                                    <div class="text-center bg-white px-2 z-0">
                                        <div class="text-2xl font-black text-slate-700 uppercase">{{ event.depCode || 'DEP' }}</div>
                                        <div class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded mt-1">{{ event.depTime || '--:--' }}</div>
                                    </div>
                                    <div class="text-blue-400 z-0 bg-white px-1"><i class="fas fa-plane"></i></div>
                                    <div class="text-center bg-white px-2 z-0">
                                        <div class="text-2xl font-black text-slate-700 uppercase">{{ event.arrCode || 'ARR' }}</div>
                                        <div class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded mt-1">{{ event.arrTime || '--:--' }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ‰∏ÄËà¨Ë°åÁ®ãÈ°ØÁ§∫ -->
                            <div v-else>
                                <h3 class="text-lg font-bold text-dark mb-1 leading-snug pr-6">{{ event.title }}</h3>
                                <p v-if="event.note" class="text-xs text-slate-500 bg-slate-50 inline-block px-2 py-1 rounded-md mb-3 border border-slate-100">
                                    <i class="fas fa-sticky-note mr-1 text-slate-300"></i>{{ event.note }}
                                </p>
                                <p v-else class="mb-3"></p>
                                <div class="flex gap-2">
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(event.title + ' È¶ôÊ∏Ø')" target="_blank" @click.stop 
                                       class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold hover:bg-slate-200 transition">
                                        <i class="fas fa-location-arrow"></i> Â∞éËà™
                                    </a>
                                    <!-- Êñ∞Â¢ûÔºöÂàáÊèõÂà∞ App ÂÖßÂª∫Âú∞Âúñ -->
                                    <button @click.stop="switchTab('map')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-rose-50 text-rose-600 text-[10px] font-bold hover:bg-rose-100 transition">
                                        <i class="fas fa-map"></i> Êü•ÁúãÂú∞Âúñ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Â∫ïÈÉ®Êñ∞Â¢ûÊåâÈàïÁæ§ -->
            <div v-if="tripDays[activeDay]?.events.length > 0" class="flex gap-3 mt-2">
                <button @click="addEvent" class="flex-1 py-4 rounded-2xl border-2 border-dashed border-primary/30 text-primary font-bold text-sm hover:bg-primary/5 transition-all">
                    <i class="fas fa-plus mr-1"></i> Ë°åÁ®ã
                </button>
                <button @click="addFlight" class="flex-1 py-4 rounded-2xl border-2 border-dashed border-blue-300 text-blue-500 font-bold text-sm hover:bg-blue-50 transition-all">
                    <i class="fas fa-plane mr-1"></i> Ëà™Áè≠
                </button>
            </div>
        </div>

        <!-- Tab 2: ÂàÜÂ∏≥Èå¢ÂåÖ -->
        <div v-else-if="currentTab === 'wallet'" class="px-5 pt-6 pb-28 space-y-6">
            <!-- ÂåØÁéáËΩâÊèõÂô® -->
            <div class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between border border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-xs font-bold">$$</div>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-slate-500">ÂåØÁéá (HKD ‚Üí TWD)</span>
                        <span class="text-[10px] text-slate-400" v-if="lastRateUpdate">Êõ¥Êñ∞: {{ lastRateUpdate }}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input v-model.number="exchangeRate" @change="updateData" type="number" step="0.01" class="w-20 text-right font-bold text-dark bg-slate-50 rounded-lg px-2 py-1 outline-none focus:ring-1 focus:ring-primary">
                    <button @click="fetchExchangeRate" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 flex items-center justify-center transition" title="Êõ¥Êñ∞Âç≥ÊôÇÂåØÁéá">
                        <i :class="['fas fa-sync-alt', isFetchingRate ? 'fa-spin' : '']"></i>
                    </button>
                </div>
            </div>

            <!-- ÊàêÂì°ÁÆ°ÁêÜ -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="fas fa-users"></i> ÂàÜÂ∏≥ÊàêÂì°</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3">
                    <div v-for="(p, idx) in people" :key="idx" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold flex items-center group">
                        {{ p }}
                        <button @click="removePerson(idx)" class="ml-2 text-slate-300 hover:text-red-400" v-if="people.length > 1"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="newPersonName" @keyup.enter="addPerson" placeholder="Êñ∞Â¢ûÂêçÂ≠ó (‰æãÂ¶Ç: Â∞èÊòé)" class="flex-1 bg-slate-50 px-3 py-2 rounded-xl text-xs font-bold outline-none focus:ring-1 focus:ring-primary">
                    <button @click="addPerson" class="bg-dark text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md active:scale-95 transition"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <!-- Á∏ΩÊîØÂá∫ËàáÁµêÈ§ò -->
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-6 text-white shadow-lg shadow-indigo-500/30 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                <h3 class="text-indigo-100 text-xs font-bold tracking-widest uppercase mb-1">Total Expenses</h3>
                <div class="text-4xl font-bold mb-2">HKD {{ formatNumber(totalExpense) }}</div>
                <div class="text-sm text-indigo-200 bg-white/10 inline-block px-3 py-1 rounded-full backdrop-blur-md mb-6">
                    ‚âà TWD {{ formatNumber(totalExpense * exchangeRate) }}
                </div>

                <div class="space-y-2">
                    <div v-for="(person, name) in balances" :key="name" class="flex justify-between items-center text-sm bg-black/10 p-3 rounded-xl border border-white/5 backdrop-blur-sm">
                        <span class="font-bold flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-white"></div> {{ name }}
                        </span>
                        <span :class="person.balance >= 0 ? 'text-green-300' : 'text-red-300'" class="font-bold">
                            {{ person.balance >= 0 ? 'Êî∂' : '‰ªò' }} ${{ Math.abs(person.balance) }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûË®òÂ∏≥ÂçÄ (ÂÑ™ÂåñÁâà) -->
            <div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-50">
                <h4 class="text-sm font-bold text-slate-700 mb-4">Ë®ò‰∏ä‰∏ÄÁ≠Ü</h4>
                <div class="space-y-3">
                    <input v-model="newExpense.item" placeholder="È†ÖÁõÆ (‰æãÂ¶Ç: ÊôöÈ§ê)" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-medium outline-none">
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <span class="absolute left-4 top-4 text-slate-400 text-xs font-bold">HKD</span>
                            <input v-model.number="newExpense.amount" type="number" placeholder="Á∏ΩÈáëÈ°ç" class="w-full bg-slate-50 pl-12 p-4 rounded-2xl text-sm font-bold outline-none">
                        </div>
                        <div class="flex-1">
                            <span class="text-[10px] text-slate-400 font-bold ml-1">Ë™∞ÂÖà‰ªòÈå¢?</span>
                            <select v-model="newExpense.payer" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold outline-none text-slate-600 mt-1">
                                <option v-for="p in people" :value="p">{{ p }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- ÂàÜÂ∏≥Ê®°ÂºèÂàáÊèõ -->
                    <div class="bg-slate-50 p-3 rounded-2xl mt-2">
                        <div class="flex mb-3 bg-white rounded-xl p-1 shadow-sm">
                            <button @click="newExpense.splitType = 'even'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', newExpense.splitType === 'even' ? 'bg-primary text-white shadow-sm' : 'text-slate-400']">ÂùáÂàÜ (Average)</button>
                            <button @click="newExpense.splitType = 'custom'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', newExpense.splitType === 'custom' ? 'bg-primary text-white shadow-sm' : 'text-slate-400']">Ëá™Ë®Ç (Custom)</button>
                        </div>

                        <!-- ÂùáÂàÜÊ®°ÂºèÔºöÂãæÈÅ∏ÊàêÂì° -->
                        <div v-if="newExpense.splitType === 'even'" class="flex flex-wrap gap-2">
                            <label v-for="p in people" :key="p" class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl text-xs font-bold text-slate-600 border border-slate-100 cursor-pointer select-none">
                                <input type="checkbox" :value="p" v-model="newExpense.involvedMembers" class="accent-primary rounded">
                                {{ p }}
                            </label>
                        </div>

                        <!-- Ëá™Ë®ÇÊ®°ÂºèÔºöËº∏ÂÖ•ÈáëÈ°ç -->
                        <div v-else class="space-y-2">
                            <div v-for="p in people" :key="p" class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-500 w-16 truncate">{{ p }}</span>
                                <input v-model.number="newExpense.customAmounts[p]" type="number" placeholder="0" class="flex-1 bg-white p-2 rounded-lg text-xs outline-none border border-slate-100 focus:border-primary">
                            </div>
                            <div class="text-right text-[10px] font-bold" :class="customTotal === newExpense.amount ? 'text-green-500' : 'text-red-400'">
                                ÁõÆÂâçÂàÜÈÖç: ${{ customTotal }} / ${{ newExpense.amount || 0 }}
                            </div>
                        </div>
                    </div>

                    <button @click="addExpense" class="w-full bg-dark text-white py-4 rounded-2xl font-bold shadow-lg shadow-dark/20 active:scale-[0.98] transition-transform">
                        Á¢∫Ë™çË®òÂ∏≥
                    </button>
                </div>
            </div>

            <!-- ÂàóË°® -->
            <div class="space-y-3 pb-4">
                <h4 class="text-sm font-bold text-slate-400 ml-2">ÊúÄËøëÁ¥ÄÈåÑ</h4>
                <div v-for="(exp, idx) in expenses" :key="idx" class="flex flex-col bg-white p-4 rounded-2xl border border-slate-50 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fas fa-shopping-bag"></i></div>
                            <div>
                                <div class="font-bold text-dark text-sm">{{ exp.item }}</div>
                                <div class="text-[10px] text-slate-400 font-medium">{{ exp.payer }} ÂÖà‰ªò</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-dark text-sm">HKD {{ exp.amount }}</div>
                            <button @click="removeExpense(idx)" class="text-[10px] text-slate-300 hover:text-red-400 mt-1">Âà™Èô§</button>
                        </div>
                    </div>
                    <!-- È°ØÁ§∫ÂàÜÂ∏≥Ë©≥ÊÉÖ -->
                    <div class="bg-slate-50 rounded-lg p-2 text-[10px] text-slate-500">
                        <div v-if="exp.splitType === 'even'">
                            <span class="font-bold">ÂùáÂàÜÊàêÂì°:</span> {{ exp.involvedMembers.join(', ') }} 
                            (ÊØè‰∫∫ ${{ Math.round(exp.amount / exp.involvedMembers.length) }})
                        </div>
                        <div v-else>
                            <span class="font-bold">Ëá™Ë®ÇÂàÜÂ∏≥:</span> 
                            <span v-for="(amt, name) in exp.customAmounts" :key="name" v-show="amt > 0" class="mr-2">
                                {{ name }}:${{ amt }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: ÂÖ®Ëû¢ÂπïÂú∞Âúñ -->
        <div v-show="currentTab === 'map'" class="absolute inset-0 z-0 bg-slate-200">
            <div id="map-container" class="w-full h-full"></div>
            <div class="absolute bottom-32 right-6 flex flex-col gap-3 z-[400]">
                <button @click="locateUser" class="w-14 h-14 bg-white text-primary rounded-full shadow-float flex items-center justify-center text-xl active:scale-90 transition-transform"><i class="fas fa-location-crosshairs"></i></button>
                <button @click="refreshMapMarkers" class="w-14 h-14 bg-dark text-white rounded-full shadow-float flex items-center justify-center text-xl active:scale-90 transition-transform"><i class="fas fa-rotate"></i></button>
            </div>
            <div class="absolute top-4 left-4 right-4 bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-soft z-[400] border border-white/50">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-xs font-bold text-slate-400 uppercase">Map View</h4>
                        <p class="text-sm font-bold text-dark">Day {{ activeDay + 1 }} Ë°åÁ®ãÂú∞Âúñ</p>
                    </div>
                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded font-bold" v-if="syncStatus === 'done'">Â∑≤ÂêåÊ≠•</span>
                    <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded font-bold" v-else-if="syncStatus === 'syncing'">Êõ¥Êñ∞‰∏≠...</span>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Â∫ïÈÉ®Â∞éËà™ -->
    <nav class="fixed bottom-0 w-full max-w-[430px] z-50 px-6 pb-6 pt-2 pointer-events-none">
        <div class="bg-white/90 backdrop-blur-xl border border-white/40 shadow-float rounded-3xl flex justify-around items-center py-3 px-2 pointer-events-auto">
            <button @click="switchTab('itinerary')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'itinerary' ? 'text-primary -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'itinerary' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-calendar-check"></i></div>
                <span class="text-[10px] font-bold">Plan</span>
            </button>
            <button @click="switchTab('wallet')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'wallet' ? 'text-indigo-500 -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'wallet' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-wallet"></i></div>
                <span class="text-[10px] font-bold">Wallet</span>
            </button>
            <button @click="switchTab('map')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'map' ? 'text-rose-500 -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'map' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-map"></i></div>
                <span class="text-[10px] font-bold">Map</span>
            </button>
        </div>
    </nav>
</div>

<!-- Scripts -->
<script type="module">
    import { createApp, ref, computed, onMounted, nextTick, watch, onUnmounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref as dbRef, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ==========================================
    // üîë Ë´ãÂú®Ê≠§Â°´ÂÖ• Firebase Key
    // ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyCVRY4qEL_4Q3fxHammQBKODlfrhuTP37U",
  authDomain: "hk-tour.firebaseapp.com",
  databaseURL: "https://hk-tour-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hk-tour",
  storageBucket: "hk-tour.firebasestorage.app",
  messagingSenderId: "764791659242",
  appId: "1:764791659242:web:f478ee64f1013067705593",
  measurementId: "G-3RYVGRSDX7"
};

    let db = null, tripRef = null, isRemoteUpdate = false;
    const urlParams = new URLSearchParams(window.location.search);
    let tripId = urlParams.get('id');
    
    // Â¶ÇÊûúÁ∂≤ÂùÄÊ≤íÊúâ IDÔºåËá™ÂãïÁî¢Áîü ID
    if (!tripId) {
        tripId = 'trip_' + Math.random().toString(36).substr(2, 6);
        try {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + tripId;
            window.history.replaceState({path:newUrl},'',newUrl);
        } catch (e) { console.log("È†êË¶ΩÁí∞Â¢ÉÁï•ÈÅéÁ∂≤ÂùÄ‰øÆÊîπ"); }
    }

    // ÂàùÂßãÂåñ Firebase (Â¶ÇÊûúÊúâ Key)
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        tripRef = dbRef(db, `trips/${tripId}`);
        console.log("Connected to Cloud (Multiplayer):", tripId);
    } else {
        console.log("Firebase Key not found. Using LocalStorage (Single Player).");
    }

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const weather = ref({ temp: null, icon: null });
            const syncStatus = ref('idle');
            
            const activeDay = ref(0);
            const tripDays = ref([
                { events: [] }
            ]);
            const exchangeRate = ref(4.1);
            const lastRateUpdate = ref(''); // ÂåØÁéáÊõ¥Êñ∞ÊôÇÈñì
            const isFetchingRate = ref(false); // ÂåØÁéáËºâÂÖ•‰∏≠ÁãÄÊÖã

            const people = ref(['Êàë', 'ÊúãÂèã']);
            const expenses = ref([]);
            
            // Êñ∞Â¢ûÂàÜÂ∏≥Áî®ÁöÑË≥áÊñôÁµêÊßã
            const newExpense = ref({ 
                item: '', 
                amount: '', 
                payer: 'Êàë',
                splitType: 'even', // 'even' (ÂùáÂàÜ) Êàñ 'custom' (Ëá™Ë®Ç)
                involvedMembers: [], // ÂùáÂàÜÊôÇÈÅ∏‰∏≠ÁöÑ‰∫∫
                customAmounts: {} // Ëá™Ë®ÇÊôÇÊØèÂÄã‰∫∫ÁöÑÈáëÈ°ç
            });
            const newPersonName = ref('');

            let mapInstance = null, markers = [], userMarker = null;

            // Sortable Áõ∏Èóú
            const eventListRef = ref(null);
            let sortableInstance = null;

            const saveModeText = computed(() => db ? 'Èõ≤Á´Ø' : 'Êú¨Ê©ü');

            // ÂåØÁéáÊäìÂèñÂäüËÉΩ (ExchangeRate-API)
            const fetchExchangeRate = async () => {
                isFetchingRate.value = true;
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                    const data = await res.json();
                    if(data && data.rates && data.rates.TWD) {
                        exchangeRate.value = parseFloat(data.rates.TWD.toFixed(2));
                        const now = new Date();
                        lastRateUpdate.value = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                        updateData(); // ÂÑ≤Â≠òÊõ¥Êñ∞ÂæåÁöÑÂåØÁéá
                        alert(`ÂåØÁéáÂ∑≤Êõ¥Êñ∞ÔºÅÁõÆÂâç 1 HKD ‚âà ${exchangeRate.value} TWD`);
                    } else {
                        alert("ÁÑ°Ê≥ïÂèñÂæóÂåØÁéáË≥áÊñôÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ");
                    }
                } catch(e) {
                    console.error(e);
                    alert("ÂåØÁéáÊõ¥Êñ∞Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ");
                } finally {
                    isFetchingRate.value = false;
                }
            };

            // ÂàùÂßãÂåñ Sortable
            const initSortable = () => {
                if (sortableInstance) sortableInstance.destroy();
                if (!eventListRef.value) return;
                
                sortableInstance = new Sortable(eventListRef.value, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        if (evt.oldIndex === evt.newIndex) return;
                        const list = tripDays.value[activeDay.value].events;
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                        updateData();
                    }
                });
            };

            watch(activeDay, () => { nextTick(initSortable); });

            // ÂàùÂßãÂåñÂàÜÂ∏≥È†êË®≠ÂÄº (ÂÖ®ÈÅ∏)
            watch(people, (newPeople) => {
                // Áï∂ÊàêÂì°ËÆäÂãïÊôÇÔºåÁ¢∫‰øù involvedMembers ÂåÖÂê´ÊâÄÊúâ‰∫∫ (Â¶ÇÊûúÊòØÊñ∞ÁöÑ expense)
                if(newExpense.value.involvedMembers.length === 0) {
                    newExpense.value.involvedMembers = [...newPeople];
                }
                // ÂàùÂßãÂåñ customAmounts
                newPeople.forEach(p => {
                    if(!(p in newExpense.value.customAmounts)) {
                        newExpense.value.customAmounts[p] = 0;
                    }
                });
            }, { immediate: true });

            const customTotal = computed(() => {
                let sum = 0;
                for(let p in newExpense.value.customAmounts) {
                    sum += (newExpense.value.customAmounts[p] || 0);
                }
                return sum;
            });

            onMounted(() => {
                if (db && tripRef) {
                    onValue(tripRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            isRemoteUpdate = true;
                            loadDataIntoVue(data);
                            setTimeout(() => isRemoteUpdate = false, 100);
                        }
                    });
                } else {
                    const localData = localStorage.getItem('hk_trip_' + tripId);
                    if (localData) {
                        loadDataIntoVue(JSON.parse(localData));
                    }
                    nextTick(initSortable);
                }
                fetchWeather();
            });

            const loadDataIntoVue = (data) => {
                tripDays.value = data.tripDays || tripDays.value;
                expenses.value = data.expenses || [];
                exchangeRate.value = data.exchangeRate || 4.1;
                people.value = data.people || people.value;
                if(currentTab.value === 'map') refreshMapMarkers();
                syncStatus.value = 'done';
                nextTick(initSortable);
            };

            const updateData = () => {
                if (isRemoteUpdate) return;
                syncStatus.value = 'syncing';
                
                const dataToSave = {
                    tripDays: JSON.parse(JSON.stringify(tripDays.value)),
                    expenses: JSON.parse(JSON.stringify(expenses.value)),
                    exchangeRate: exchangeRate.value,
                    people: people.value,
                    lastUpdated: new Date().toISOString()
                };

                if (db && tripRef) {
                    set(tripRef, dataToSave).then(() => setTimeout(() => syncStatus.value = 'done', 500));
                } else {
                    localStorage.setItem('hk_trip_' + tripId, JSON.stringify(dataToSave));
                    setTimeout(() => syncStatus.value = 'done', 300);
                }
            };

            let timer;
            watch([tripDays, expenses, exchangeRate, people], () => { 
                if(isRemoteUpdate) return;
                clearTimeout(timer);
                syncStatus.value = 'syncing';
                timer = setTimeout(updateData, 1000);
            }, { deep: true });

            const addDay = () => { 
                tripDays.value.push({ events: [] }); 
                activeDay.value = tripDays.value.length - 1; 
                updateData(); 
            };
            
            const removeDay = (index) => {
                if(tripDays.value.length <= 1) return alert("Ëá≥Â∞ëÈúÄ‰øùÁïô‰∏ÄÂ§©Ë°åÁ®ãÔºÅ");
                if(confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ Day ${index + 1} ÁöÑÊâÄÊúâË°åÁ®ãÂóéÔºü\nÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                    tripDays.value.splice(index, 1);
                    if(activeDay.value >= tripDays.value.length) activeDay.value = Math.max(0, tripDays.value.length - 1);
                    updateData();
                }
            };

            const addEvent = () => { tripDays.value[activeDay.value].events.push({ type: 'event', time: '12:00', title: '', isEditing: true, id: Date.now() }); };
            const addFlight = () => {
                tripDays.value[activeDay.value].events.push({ 
                    type: 'flight', 
                    depCode: '', depTime: '10:00',
                    arrCode: '', arrTime: '12:00',
                    title: '', isEditing: true,
                    id: Date.now()
                });
                updateData();
            };
            const removeEvent = (i) => { tripDays.value[activeDay.value].events.splice(i, 1); updateData(); };
            
            // Êñ∞Â¢ûÊ∂àË≤ªÈÇèËºØÊõ¥Êñ∞
            const addExpense = () => {
                const { item, amount, payer, splitType, involvedMembers, customAmounts } = newExpense.value;
                
                if(!item || !amount) return alert("Ë´ãËº∏ÂÖ•È†ÖÁõÆÂíåÈáëÈ°ç");
                
                // È©óË≠âËá™Ë®ÇÈáëÈ°çÊòØÂê¶Ê≠£Á¢∫
                if(splitType === 'custom') {
                    if(customTotal.value !== amount) return alert(`ÂàÜÈÖçÈáëÈ°çÁ∏ΩÂíå ($${customTotal.value}) ‰∏çÁ≠âÊñºÁ∏ΩÈáëÈ°ç ($${amount})`);
                } else {
                    if(involvedMembers.length === 0) return alert("Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏Ä‰ΩçÂàÜÂ∏≥ÊàêÂì°");
                }

                // Ê∑±Êã∑Ë≤ù customAmounts ‰ª•ÂÖçÂæåÁ∫å‰øÆÊîπÂΩ±ÈüøÂ∑≤Â≠òË≥áÊñô
                const savedCustomAmounts = JSON.parse(JSON.stringify(customAmounts));

                expenses.value.unshift({ 
                    item, 
                    amount, 
                    payer, 
                    splitType,
                    involvedMembers: [...involvedMembers], // Ë§áË£ΩÈô£Âàó
                    customAmounts: savedCustomAmounts
                });
                
                // ÈáçÁΩÆË°®ÂñÆ (‰øùÁïô payer ÂíåÊ®°Âºè)
                newExpense.value.item = '';
                newExpense.value.amount = '';
                // ÈÄôË£°‰∏çÈáçÁΩÆÊàêÂì°ÈÅ∏ÊìáÔºåÊñπ‰æøÈÄ£Á∫åË®òÂ∏≥
                // newExpense.value.involvedMembers = [...people.value]; 
                // newExpense.value.customAmounts = {}; // customAmounts Ê≠∏Èõ∂
                people.value.forEach(p => newExpense.value.customAmounts[p] = 0);

                updateData();
            };

            const removeExpense = (i) => { expenses.value.splice(i, 1); updateData(); };

            const addPerson = () => {
                const name = newPersonName.value.trim();
                if (name && !people.value.includes(name)) {
                    people.value.push(name);
                    newPersonName.value = '';
                    updateData();
                }
            };
            
            const removePerson = (index) => {
                if(confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ÊàêÂì°„Äå${people.value[index]}„ÄçÂóéÔºü`)) {
                    people.value.splice(index, 1);
                    updateData();
                }
            };

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (item.amount || 0), 0));
            
            // Ê†∏ÂøÉÂàÜÂ∏≥ÈÇèËºØ (Balance Calculation)
            const balances = computed(() => {
                let bal = {};
                // ÂàùÂßãÂåñÊØèÂÄã‰∫∫
                people.value.forEach(p => bal[p] = { paid: 0, shouldPay: 0, balance: 0 });
                
                expenses.value.forEach(exp => {
                    const payer = exp.payer;
                    const amount = exp.amount;
                    
                    // 1. Ë®òÈåÑË™∞ÂÖà‰ªòÈå¢ (Credit)
                    if(bal[payer]) bal[payer].paid += amount;

                    // 2. Ë®òÈåÑË™∞Ë©≤‰ªòÈå¢ (Debit)
                    if (exp.splitType === 'custom') {
                        // Ëá™Ë®ÇÊ®°ÂºèÔºöÁõ¥Êé•ÂèñÁî®Ë®≠ÂÆöÂ•ΩÁöÑÈáëÈ°ç
                        for (let person in exp.customAmounts) {
                            if(bal[person]) bal[person].shouldPay += (exp.customAmounts[person] || 0);
                        }
                    } else {
                        // ÂùáÂàÜÊ®°ÂºèÔºöÁ∏ΩÈáëÈ°ç / ‰∫∫Êï∏
                        // Áõ∏ÂÆπËàäË≥áÊñô (Ê≤íÊúâ involvedMembers Ê¨Ñ‰ΩçÊôÇÈ†êË®≠ÂÖ®ÈÉ®ÂàÜ)
                        const involved = (exp.involvedMembers && exp.involvedMembers.length > 0) ? exp.involvedMembers : people.value;
                        const splitAmount = amount / involved.length;
                        involved.forEach(person => {
                            if(bal[person]) bal[person].shouldPay += splitAmount;
                        });
                    }
                });

                // 3. Ë®àÁÆóÊúÄÁµÇÁµêÈ§ò (Ê≠£Êï∏=ÊáâÊî∂ÔºåË≤†Êï∏=Êáâ‰ªò)
                for(let p in bal) {
                    bal[p].balance = Math.round(bal[p].paid - bal[p].shouldPay);
                }
                return bal;
            });

            const formatNumber = (num) => new Intl.NumberFormat().format(Math.round(num));

            const copyLink = () => {
                navigator.clipboard.writeText(window.location.href);
                alert("Á∂≤ÂùÄÂ∑≤Ë§áË£ΩÔºÅÂÇ≥Áµ¶ÊúãÂèãÂç≥ÂèØÂêåÊ≠•„ÄÇ\nID: " + tripId);
            };

            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=22.31&longitude=114.16&current_weather=true');
                    const d = await res.json();
                    if(d.current_weather) {
                        weather.value.temp = Math.round(d.current_weather.temperature);
                        const c = d.current_weather.weathercode;
                        weather.value.icon = c <= 1 ? 'fas fa-sun text-yellow-400' : (c <= 60 ? 'fas fa-cloud text-slate-200' : 'fas fa-umbrella text-blue-400');
                    }
                } catch(e) {}
            };

            const switchTab = async (tab) => {
                currentTab.value = tab;
                if (tab === 'map') {
                    await nextTick();
                    if(!mapInstance) initMap();
                    mapInstance.invalidateSize();
                    refreshMapMarkers();
                }
                if (tab === 'itinerary') nextTick(initSortable);
            };

            const initMap = () => {
                mapInstance = L.map('map-container').setView([22.3193, 114.1694], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(mapInstance);
            };

            const refreshMapMarkers = async () => {
                if (!mapInstance) return;
                markers.forEach(m => mapInstance.removeLayer(m));
                markers = [];
                const events = tripDays.value[activeDay.value]?.events || [];
                const bounds = L.latLngBounds();
                for (let event of events) {
                    if (!event.title || event.type === 'flight') continue; 
                    try {
                        const query = encodeURIComponent(`Hong Kong ${event.title}`);
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`);
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const { lat, lon } = data[0];
                            const marker = L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${event.title}</b><br>${event.time}`);
                            markers.push(marker);
                            bounds.extend([lat, lon]);
                        }
                    } catch (e) {}
                }
                if (markers.length > 0) mapInstance.fitBounds(bounds, { padding: [80, 80] });
            };
            
            const locateUser = () => {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if (userMarker) mapInstance.removeLayer(userMarker);
                    userMarker = L.marker([latitude, longitude], { 
                        icon: L.divIcon({ html: '<div style="width:16px;height:16px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>' }) 
                    }).addTo(mapInstance);
                    mapInstance.setView([latitude, longitude], 15);
                });
            };

            return {
                tripId, currentTab, weather, activeDay, tripDays, expenses, exchangeRate, lastRateUpdate, isFetchingRate, people, newExpense, balances, totalExpense, syncStatus, saveModeText, customTotal,
                currentTabName: computed(() => {
                    if (currentTab.value === 'itinerary') return 'Plan';
                    if (currentTab.value === 'wallet') return 'Wallet';
                    if (currentTab.value === 'map') return 'Map';
                }),
                addDay, removeDay, addEvent, addFlight, removeEvent, addExpense, removeExpense, updateData, switchTab, copyLink, formatNumber, locateUser, refreshMapMarkers, fetchExchangeRate,
                newPersonName, addPerson, removePerson,
                eventListRef
            };
        }
    }).mount('#app');
</script>
</body>
</html>