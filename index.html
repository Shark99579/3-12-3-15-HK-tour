<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HK Travel Plan âœˆï¸</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS (åœ°åœ–) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SortableJS (æ‹–æ›³æ’åº) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2DD4BF', // æ¹–æ°´ç¶  Teal-400
                        secondary: '#F0FDFA', // æ·ºæ¹–æ°´ç¶ èƒŒæ™¯
                        accent: '#F43F5E',   // é»ç¶´è‰² (Rose)
                        food: '#F59E0B',     // ç¾é£Ÿæ©˜
                        shop: '#EC4899',     // è³¼ç‰©ç²‰
                        dark: '#334155',
                        'card-bg': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['"Poppins"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ‰‹æ©Ÿæ¨¡æ“¬æ¡† (æ¡Œé¢ç‰ˆæ™‚é¡¯ç¤º) */
        @media (min-width: 640px) {
            body { display: flex; justify-content: center; min-height: 100vh; align-items: center; padding: 20px; background-image: linear-gradient(135deg, #e0f2fe 0%, #f0fdfa 100%); }
            #app { width: 100%; max-width: 430px; height: 880px; max-height: 92vh; border-radius: 40px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 8px solid #fff; }
        }

        /* å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* è¡Œç¨‹å¡ç‰‡å·¦å´ç·šæ¢ */
        .timeline-line { position: absolute; left: 24px; top: 40px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
        .last-item .timeline-line { display: none; }

        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .sortable-ghost { opacity: 0.4; background: #f0f9ff; border: 2px dashed #2DD4BF; }
        .drag-handle { cursor: move; touch-action: none; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-full bg-slate-50 relative group">
    
    <!-- é ‚éƒ¨ç‹€æ…‹åˆ—èˆ‡å°é¢ (è¡Œç¨‹é é¢å°ˆç”¨) -->
    <div v-if="currentTab === 'itinerary'" class="relative h-56 w-full shrink-0 overflow-hidden rounded-b-[3rem] shadow-soft z-10 bg-gradient-to-br from-teal-400 to-teal-600">
        <!-- è£é£¾åœ“åœˆ -->
        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        <div class="absolute top-20 -left-10 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>

        <div class="absolute top-0 w-full p-6 pt-12 flex justify-between items-start text-white">
            <div>
                <div class="flex items-center gap-2 opacity-90 mb-1">
                    <span class="text-xs font-medium tracking-widest uppercase bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm">ID: {{ tripId.substring(0,6) }}</span>
                    <button @click="copyLink" class="bg-white/20 hover:bg-white/40 p-1.5 rounded-full backdrop-blur-md transition">
                        <i class="fas fa-share-alt text-xs"></i>
                    </button>
                    
                    <!-- å„²å­˜ç‹€æ…‹æŒ‡ç¤ºç‡ˆ (è¡Œç¨‹é ) -->
                    <span v-if="syncStatus === 'syncing'" class="text-[10px] font-bold bg-yellow-400/90 text-black px-2 py-0.5 rounded backdrop-blur-sm shadow-sm transition-all">
                        <i class="fas fa-sync fa-spin mr-1"></i>å„²å­˜ä¸­...
                    </span>
                    <span v-else-if="syncStatus === 'done'" class="text-[10px] font-bold bg-white/20 text-white px-2 py-0.5 rounded backdrop-blur-sm shadow-sm transition-all">
                        <i class="fas fa-check mr-1"></i>å·²å„²å­˜ ({{ saveModeText }})
                    </span>
                </div>
                <h1 class="text-3xl font-bold drop-shadow-sm">3/12~3/15é¦™æ¸¯tour</h1>
            </div>
            <div class="flex flex-col items-end">
                <div class="bg-white/20 backdrop-blur-md rounded-2xl p-2.5 flex flex-col items-center text-white shadow-lg border border-white/20">
                    <i v-if="weather.icon" :class="[weather.icon, 'text-2xl mb-1 drop-shadow-sm']"></i>
                    <span class="text-sm font-bold">{{ weather.temp ? weather.temp + 'Â°' : '--' }}</span>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-0 w-full px-6">
            <div class="flex space-x-3 overflow-x-auto pb-4 pt-4 hide-scrollbar snap-x items-end">
                <!-- æ—¥æœŸå¡ç‰‡ (å›ºå®šå››å¤©) -->
                <div v-for="(day, index) in tripDays" :key="index" class="snap-center shrink-0 relative group">
                    <button @click="activeDay = index" class="outline-none block">
                        <div :class="['px-4 py-2 rounded-2xl flex flex-col items-center min-w-[64px] transition-all duration-300 border', 
                            activeDay === index ? 'bg-white text-teal-600 shadow-lg scale-105 border-white' : 'bg-white/20 text-white border-white/10 hover:bg-white/30 backdrop-blur-md']">
                            <span class="text-[10px] font-bold tracking-wide uppercase opacity-90">Day</span>
                            <span class="text-xl font-bold">{{ index + 1 }}</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œ (å…¶ä»–åˆ†é ç”¨) -->
    <div v-else class="pt-12 pb-6 px-6 bg-white rounded-b-[2rem] shadow-sm z-10 shrink-0">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-dark">{{ currentTabName }}</h1>
                <!-- å„²å­˜ç‹€æ…‹æŒ‡ç¤º (é€šç”¨é é¢) -->
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-slate-400 text-xs">ID: {{ tripId.substring(0,6) }}</span>
                    <span v-if="syncStatus === 'syncing'" class="text-xs font-bold text-yellow-500 bg-yellow-50 px-2 py-0.5 rounded-full"><i class="fas fa-circle-notch fa-spin mr-1"></i>å„²å­˜ä¸­...</span>
                    <span v-else-if="syncStatus === 'done'" class="text-xs font-bold text-green-500 bg-green-50 px-2 py-0.5 rounded-full"><i class="fas fa-check-circle mr-1"></i>å·²å„²å­˜ ({{ saveModeText }})</span>
                    <span v-else class="text-slate-300 text-xs">â€¢ å¾…æ©Ÿä¸­</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-1 overflow-y-auto hide-scrollbar relative bg-slate-50">
        
        <!-- Tab 1: è¡Œç¨‹è¡¨ -->
        <div v-if="currentTab === 'itinerary'" class="px-5 pt-6 pb-28 space-y-4">
            
            <div v-if="!currentDay" class="text-center py-10 text-slate-400">è¼‰å…¥ä¸­...</div>
            <div v-else-if="currentDay.events.length === 0" class="text-center py-12">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300 text-2xl">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <p class="text-slate-400 text-sm">Day {{ activeDay + 1 }} é‚„æ²’æœ‰è¨ˆç•«å–”</p>
                <div class="flex gap-2 justify-center mt-4">
                     <button @click="addEvent" class="px-5 py-2 bg-primary text-white rounded-full text-sm font-bold shadow-lg shadow-primary/30">æ–°å¢è¡Œç¨‹</button>
                     <button @click="addFlight" class="px-5 py-2 bg-white text-primary border border-primary rounded-full text-sm font-bold shadow-sm">æ–°å¢èˆªç­</button>
                </div>
            </div>

            <!-- æ‹–æ›³å®¹å™¨ Sortable Container -->
            <div ref="eventListRef" class="space-y-4 pb-2 min-h-[50px]">
                <div v-for="(event, idx) in currentDay?.events" :key="event.id || idx" 
                     :class="['relative transition-all duration-300', event.type === 'flight' ? 'pl-2' : 'pl-14 last-item-check']">
                    
                    <!-- å·¦å´æ™‚é–“è»¸ -->
                    <div v-if="event.type !== 'flight'" class="absolute left-0 top-0 w-12 flex flex-col items-center z-10 pointer-events-none">
                        <span class="text-xs font-bold text-slate-400 mb-1">{{ event.time }}</span>
                        <div class="w-3 h-3 rounded-full bg-primary border-2 border-white ring-2 ring-slate-100"></div>
                    </div>
                    <div v-if="event.type !== 'flight'" class="timeline-line"></div>

                    <!-- å¡ç‰‡å¤–å±¤å®¹å™¨ (è™•ç†æ»‘å‹•èˆ‡åˆªé™¤èƒŒæ™¯) -->
                    <div class="relative overflow-hidden rounded-3xl shadow-soft">
                        <!-- åˆªé™¤èƒŒæ™¯å±¤ -->
                        <div class="absolute inset-0 bg-red-500 flex items-center justify-end pr-6 text-white z-0" @click="removeItem(idx)">
                            <div class="flex flex-col items-center gap-1 font-bold text-xs">
                                <i class="fas fa-trash-alt text-lg"></i>
                                <span>åˆªé™¤</span>
                            </div>
                        </div>

                        <!-- å¡ç‰‡æœ¬é«” (å¯æ»‘å‹•å±¤) -->
                        <div :class="['relative z-10 transition-transform duration-200 ease-out border', 
                            event.type === 'flight' ? 'bg-white border-blue-100 p-0 overflow-hidden' : 'bg-white border-slate-100 p-5']"
                            :style="{ transform: `translateX(${event.swipeOffset || 0}px)` }"
                            @touchstart="touchStart($event, idx)"
                            @touchmove="touchMove($event, idx)"
                            @touchend="touchEnd($event, idx)"
                        >
                            <div class="drag-handle absolute right-3 top-3 text-slate-300 p-2 hover:text-slate-500 z-20 cursor-move"><i class="fas fa-bars"></i></div>

                            <!-- ç·¨è¼¯/é¡¯ç¤ºæ¨¡å¼ å…±ç”¨é‚è¼¯ -->
                            <div v-if="event.isEditing" class="p-4 space-y-3">
                                <div class="flex justify-between items-center text-xs font-bold uppercase tracking-wide">
                                    <span :class="event.type==='flight'?'text-blue-500':'text-primary'">Editing</span>
                                    <button @click="removeItem(idx)" class="text-slate-300 hover:text-red-400 px-2 py-1"><i class="fas fa-trash"></i></button>
                                </div>
                                <div v-if="event.type === 'flight'" class="space-y-3">
                                    <input v-model="event.title" placeholder="èˆªç­ä»£è™Ÿ" class="w-full bg-slate-50 p-3 rounded-xl font-bold text-dark outline-none">
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1"><label class="text-[10px] text-slate-400 font-bold">èµ·é£›</label><input v-model="event.depCode" class="w-full bg-slate-50 p-2 rounded-lg text-sm font-bold uppercase text-center outline-none"><input v-model="event.depTime" type="time" class="w-full bg-slate-50 p-2 rounded-lg text-xs text-center outline-none"></div>
                                        <i class="fas fa-plane text-blue-300"></i>
                                        <div class="flex-1"><label class="text-[10px] text-slate-400 font-bold">é™è½</label><input v-model="event.arrCode" class="w-full bg-slate-50 p-2 rounded-lg text-sm font-bold uppercase text-center outline-none"><input v-model="event.arrTime" type="time" class="w-full bg-slate-50 p-2 rounded-lg text-xs text-center outline-none"></div>
                                    </div>
                                </div>
                                <div v-else class="space-y-3">
                                    <input v-model="event.time" type="time" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-medium outline-none">
                                    <input v-model="event.title" placeholder="åœ°é»åç¨±" class="w-full bg-slate-50 p-3 rounded-xl font-bold text-dark outline-none">
                                    <input v-model="event.note" placeholder="å‚™è¨»" class="w-full bg-slate-50 p-3 rounded-xl text-sm text-slate-500 outline-none">
                                </div>
                                <button @click="event.isEditing = false; autoAdjustTimes(); updateData()" :class="['w-full text-white py-3 rounded-xl font-bold text-sm shadow-md', event.type==='flight'?'bg-blue-500':'bg-primary']">å®Œæˆ</button>
                            </div>

                            <div v-else @click="event.isEditing = true" class="cursor-pointer">
                                <div v-if="event.type === 'flight'" class="flex flex-col">
                                    <div class="bg-blue-500 p-3 flex justify-between items-center text-white">
                                        <div class="flex items-center gap-2"><i class="fas fa-plane-departure"></i><span class="font-bold tracking-wider">{{ event.title || 'FLIGHT' }}</span><span v-if="event.depCode" class="bg-blue-600/50 px-2 py-0.5 rounded text-xs font-mono">{{ event.depCode }} <i class="fas fa-arrow-right text-[10px] mx-1"></i> {{ event.arrCode }}</span></div>
                                    </div>
                                    <div class="p-4 flex justify-between items-center relative">
                                        <div class="absolute top-1/2 left-4 right-4 h-0.5 border-t-2 border-dashed border-slate-200 -z-1"></div>
                                        <div class="text-center bg-white px-2 z-0"><div class="text-2xl font-black text-slate-700 uppercase">{{ event.depCode }}</div><div class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded mt-1">{{ event.depTime }}</div></div>
                                        <div class="text-blue-400 z-0 bg-white px-1"><i class="fas fa-plane"></i></div>
                                        <div class="text-center bg-white px-2 z-0"><div class="text-2xl font-black text-slate-700 uppercase">{{ event.arrCode }}</div><div class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded mt-1">{{ event.arrTime }}</div></div>
                                    </div>
                                </div>
                                <div v-else>
                                    <h3 class="text-lg font-bold text-dark mb-1 leading-snug pr-6">{{ event.title }}</h3>
                                    <p v-if="event.note" class="text-xs text-slate-500 bg-slate-50 inline-block px-2 py-1 rounded-md mb-3 border border-slate-100"><i class="fas fa-sticky-note mr-1 text-slate-300"></i>{{ event.note }}</p>
                                    <p v-else class="mb-3"></p>
                                    <div class="flex gap-2">
                                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(event.title + ' é¦™æ¸¯')" target="_blank" @click.stop class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold hover:bg-slate-200 transition"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentDay?.events.length > 0" class="flex gap-3 mt-4">
                <button @click="addEvent" class="flex-1 py-4 rounded-2xl border-2 border-dashed border-primary/30 text-primary font-bold text-sm hover:bg-primary/5 transition-all"><i class="fas fa-plus mr-1"></i> è¡Œç¨‹</button>
                <button @click="addFlight" class="flex-1 py-4 rounded-2xl border-2 border-dashed border-blue-300 text-blue-500 font-bold text-sm hover:bg-blue-50 transition-all"><i class="fas fa-plane mr-1"></i> èˆªç­</button>
            </div>
        </div>

        <!-- Tab 2 & 3: ç¾é£Ÿ (Food) èˆ‡ ä¼´æ‰‹ç¦® (Shop) -->
        <div v-if="currentTab === 'food' || currentTab === 'souvenir'" class="px-5 pt-6 pb-28 space-y-4">
            <!-- æ¨™é¡Œå€ -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-4 flex items-center gap-4">
                <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-md', currentTab==='food' ? 'bg-orange-100 text-food' : 'bg-pink-100 text-shop']">
                    <i :class="['fas', currentTab==='food' ? 'fa-utensils' : 'fa-gift']"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-dark">{{ currentTabName }}æ¸…å–®</h2>
                    <p class="text-xs text-slate-400">æ»‘å‹•å¯åˆªé™¤ â€¢ æ‹–æ›³å¯æ’åº</p>
                </div>
            </div>

            <!-- å…±ç”¨åˆ—è¡¨å®¹å™¨ -->
            <div ref="eventListRef" class="space-y-4 pb-2 min-h-[50px]">
                <div v-for="(item, idx) in currentList" :key="item.id || idx" 
                     class="relative transition-all duration-300">
                    
                    <div class="relative overflow-hidden rounded-3xl shadow-soft">
                        <!-- åˆªé™¤èƒŒæ™¯ -->
                        <div class="absolute inset-0 bg-red-500 flex items-center justify-end pr-6 text-white z-0" @click="removeItem(idx)">
                            <div class="flex flex-col items-center gap-1 font-bold text-xs"><i class="fas fa-trash-alt text-lg"></i><span>åˆªé™¤</span></div>
                        </div>

                        <!-- æœ¬é«” -->
                        <div :class="['relative z-10 transition-transform duration-200 ease-out border bg-white p-5 border-slate-100']"
                            :style="{ transform: `translateX(${item.swipeOffset || 0}px)` }"
                            @touchstart="touchStart($event, idx)"
                            @touchmove="touchMove($event, idx)"
                            @touchend="touchEnd($event, idx)"
                        >
                            <div class="drag-handle absolute right-3 top-3 text-slate-300 p-2 hover:text-slate-500 z-20 cursor-move"><i class="fas fa-bars"></i></div>

                            <div v-if="item.isEditing" class="space-y-3">
                                <div class="flex justify-between text-xs font-bold uppercase tracking-wide">
                                    <span :class="currentTab==='food'?'text-food':'text-shop'">Editing</span>
                                    <button @click="removeItem(idx)" class="text-slate-300 hover:text-red-400"><i class="fas fa-trash"></i></button>
                                </div>
                                <input v-model="item.title" placeholder="åç¨± (ä¾‹: è›‹å¡”)" class="w-full bg-slate-50 p-3 rounded-xl font-bold text-dark outline-none">
                                <input v-model="item.note" placeholder="å‚™è¨» (ä¾‹: è¦è²·3ç›’)" class="w-full bg-slate-50 p-3 rounded-xl text-sm text-slate-500 outline-none">
                                <button @click="item.isEditing = false; updateData()" :class="['w-full text-white py-3 rounded-xl font-bold text-sm shadow-md', currentTab==='food'?'bg-food':'bg-shop']">å®Œæˆ</button>
                            </div>

                            <div v-else @click="item.isEditing = true" class="cursor-pointer">
                                <h3 class="text-lg font-bold text-dark mb-1 leading-snug pr-6">{{ item.title }}</h3>
                                <p v-if="item.note" class="text-xs text-slate-500 bg-slate-50 inline-block px-2 py-1 rounded-md mb-3 border border-slate-100"><i class="fas fa-sticky-note mr-1 text-slate-300"></i>{{ item.note }}</p>
                                <p v-else class="mb-3"></p>
                                <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.title + ' é¦™æ¸¯')" target="_blank" @click.stop class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold hover:bg-slate-200 transition"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="addListItem" :class="['w-full py-4 rounded-2xl border-2 border-dashed font-bold text-sm transition-all flex items-center justify-center gap-2', currentTab==='food' ? 'border-food/30 text-food hover:bg-food/5' : 'border-shop/30 text-shop hover:bg-shop/5']">
                <i class="fas fa-plus"></i> æ–°å¢{{ currentTabName }}
            </button>
        </div>

        <!-- Tab 4: Wallet -->
        <div v-else-if="currentTab === 'wallet'" class="px-5 pt-6 pb-28 space-y-6">
            <!-- åŒ¯ç‡è½‰æ›å™¨ -->
            <div class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between border border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-xs font-bold">$$</div>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-slate-500">åŒ¯ç‡ (HKD â†’ TWD)</span>
                        <span class="text-[10px] text-slate-400" v-if="lastRateUpdate">æ›´æ–°: {{ lastRateUpdate }}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input v-model.number="exchangeRate" @change="updateData" type="number" step="0.01" class="w-20 text-right font-bold text-dark bg-slate-50 rounded-lg px-2 py-1 outline-none focus:ring-1 focus:ring-primary">
                    <button @click="fetchExchangeRate" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 flex items-center justify-center transition" title="æ›´æ–°å³æ™‚åŒ¯ç‡">
                        <i :class="['fas fa-sync-alt', isFetchingRate ? 'fa-spin' : '']"></i>
                    </button>
                </div>
            </div>

            <!-- æˆå“¡ç®¡ç† -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i class="fas fa-users"></i> åˆ†å¸³æˆå“¡</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3">
                    <div v-for="(p, idx) in people" :key="idx" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold flex items-center group">
                        {{ p }}
                        <button @click="removePerson(idx)" class="ml-2 text-slate-300 hover:text-red-400" v-if="people.length > 1"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="newPersonName" @keyup.enter="addPerson" placeholder="æ–°å¢åå­— (ä¾‹å¦‚: å°æ˜)" class="flex-1 bg-slate-50 px-3 py-2 rounded-xl text-xs font-bold outline-none focus:ring-1 focus:ring-primary">
                    <button @click="addPerson" class="bg-dark text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md active:scale-95 transition"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <!-- ç¸½æ”¯å‡ºèˆ‡çµé¤˜ -->
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-6 text-white shadow-lg shadow-indigo-500/30 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                <h3 class="text-indigo-100 text-xs font-bold tracking-widest uppercase mb-1">Total Expenses</h3>
                <div class="text-4xl font-bold mb-2">HKD {{ formatNumber(totalExpense) }}</div>
                <div class="text-sm text-indigo-200 bg-white/10 inline-block px-3 py-1 rounded-full backdrop-blur-md mb-6">
                    â‰ˆ TWD {{ formatNumber(totalExpense * exchangeRate) }}
                </div>

                <div class="space-y-2">
                    <div v-for="(person, name) in balances" :key="name" class="flex justify-between items-center text-sm bg-black/10 p-3 rounded-xl border border-white/5 backdrop-blur-sm">
                        <span class="font-bold flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-white"></div> {{ name }}
                        </span>
                        <span :class="person.balance >= 0 ? 'text-green-300' : 'text-red-300'" class="font-bold">
                            {{ person.balance >= 0 ? 'æ”¶' : 'ä»˜' }} ${{ Math.abs(person.balance) }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢è¨˜å¸³å€ -->
            <div class="bg-white p-5 rounded-3xl shadow-soft border border-slate-50">
                <h4 class="text-sm font-bold text-slate-700 mb-4">è¨˜ä¸Šä¸€ç­†</h4>
                <div class="space-y-3">
                    <input v-model="newExpense.item" placeholder="é …ç›® (ä¾‹å¦‚: æ™šé¤)" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-medium outline-none">
                    
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <span class="absolute left-4 top-4 text-slate-400 text-xs font-bold">HKD</span>
                            <input v-model.number="newExpense.amount" type="number" placeholder="ç¸½é‡‘é¡" class="w-full bg-slate-50 pl-12 p-4 rounded-2xl text-sm font-bold outline-none">
                        </div>
                        <div class="flex-1">
                            <span class="text-[10px] text-slate-400 font-bold ml-1">èª°å…ˆä»˜éŒ¢?</span>
                            <select v-model="newExpense.payer" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold outline-none text-slate-600 mt-1">
                                <option v-for="p in people" :value="p">{{ p }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- åˆ†å¸³æ¨¡å¼åˆ‡æ› -->
                    <div class="bg-slate-50 p-3 rounded-2xl mt-2">
                        <div class="flex mb-3 bg-white rounded-xl p-1 shadow-sm">
                            <button @click="newExpense.splitType = 'even'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', newExpense.splitType === 'even' ? 'bg-primary text-white shadow-sm' : 'text-slate-400']">å‡åˆ† (Average)</button>
                            <button @click="newExpense.splitType = 'custom'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', newExpense.splitType === 'custom' ? 'bg-primary text-white shadow-sm' : 'text-slate-400']">è‡ªè¨‚ (Custom)</button>
                        </div>

                        <!-- å‡åˆ†æ¨¡å¼ -->
                        <div v-if="newExpense.splitType === 'even'" class="flex flex-wrap gap-2">
                            <label v-for="p in people" :key="p" class="flex items-center gap-2 bg-white px-3 py-2 rounded-xl text-xs font-bold text-slate-600 border border-slate-100 cursor-pointer select-none">
                                <input type="checkbox" :value="p" v-model="newExpense.involvedMembers" class="accent-primary rounded">
                                {{ p }}
                            </label>
                        </div>

                        <!-- è‡ªè¨‚æ¨¡å¼ -->
                        <div v-else class="space-y-2">
                            <div v-for="p in people" :key="p" class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-500 w-16 truncate">{{ p }}</span>
                                <input v-model.number="newExpense.customAmounts[p]" type="number" placeholder="0" class="flex-1 bg-white p-2 rounded-lg text-xs outline-none border border-slate-100 focus:border-primary">
                            </div>
                            <div class="text-right text-[10px] font-bold" :class="customTotal === newExpense.amount ? 'text-green-500' : 'text-red-400'">
                                ç›®å‰åˆ†é…: ${{ customTotal }} / ${{ newExpense.amount || 0 }}
                            </div>
                        </div>
                    </div>

                    <button @click="addExpense" class="w-full bg-dark text-white py-4 rounded-2xl font-bold shadow-lg shadow-dark/20 active:scale-[0.98] transition-transform">
                        ç¢ºèªè¨˜å¸³
                    </button>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="space-y-3 pb-4">
                <h4 class="text-sm font-bold text-slate-400 ml-2">æœ€è¿‘ç´€éŒ„</h4>
                <div v-for="(exp, idx) in expenses" :key="idx" class="flex flex-col bg-white p-4 rounded-2xl border border-slate-50 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fas fa-shopping-bag"></i></div>
                            <div>
                                <div class="font-bold text-dark text-sm">{{ exp.item }}</div>
                                <div class="text-[10px] text-slate-400 font-medium">{{ exp.payer }} å…ˆä»˜</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-dark text-sm">HKD {{ exp.amount }}</div>
                            <button @click="removeExpense(idx)" class="text-[10px] text-slate-300 hover:text-red-400 mt-1">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-2 text-[10px] text-slate-500">
                        <div v-if="exp.splitType === 'even'">
                            <span class="font-bold">å‡åˆ†æˆå“¡:</span> {{ exp.involvedMembers.join(', ') }} 
                            (æ¯äºº ${{ Math.round(exp.amount / exp.involvedMembers.length) }})
                        </div>
                        <div v-else>
                            <span class="font-bold">è‡ªè¨‚åˆ†å¸³:</span> 
                            <span v-for="(amt, name) in exp.customAmounts" :key="name" v-show="amt > 0" class="mr-2">
                                {{ name }}:${{ amt }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="fixed bottom-0 w-full max-w-[430px] z-50 px-6 pb-6 pt-2 pointer-events-none">
        <div class="bg-white/90 backdrop-blur-xl border border-white/40 shadow-float rounded-3xl flex justify-around items-center py-3 px-2 pointer-events-auto">
            <button @click="switchTab('itinerary')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'itinerary' ? 'text-primary -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'itinerary' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-calendar-check"></i></div>
                <span class="text-[10px] font-bold">Plan</span>
            </button>
            <button @click="switchTab('wallet')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'wallet' ? 'text-indigo-500 -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'wallet' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-wallet"></i></div>
                <span class="text-[10px] font-bold">Wallet</span>
            </button>
            <button @click="switchTab('food')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'food' ? 'text-food -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                 <div :class="['text-xl transition-all', currentTab === 'food' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-utensils"></i></div>
                 <span class="text-[10px] font-bold">Food</span>
            </button>
            <button @click="switchTab('souvenir')" :class="['relative flex flex-col items-center gap-1 w-14 transition-all duration-300', currentTab === 'souvenir' ? 'text-shop -translate-y-1' : 'text-slate-300 hover:text-slate-400']">
                <div :class="['text-xl transition-all', currentTab === 'souvenir' ? 'scale-110 drop-shadow-md' : '']"><i class="fas fa-gift"></i></div>
                <span class="text-[10px] font-bold">Shop</span>
            </button>
        </div>
    </nav>
</div>

<!-- Scripts -->
<script type="module">
    import { createApp, ref, computed, onMounted, nextTick, watch, onUnmounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref as dbRef, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ==========================================
    // ğŸ”‘ è«‹åœ¨æ­¤å¡«å…¥ Firebase Key
    // ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyCVRY4qEL_4Q3fxHammQBKODlfrhuTP37U",
  authDomain: "hk-tour.firebaseapp.com",
  databaseURL: "https://hk-tour-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hk-tour",
  storageBucket: "hk-tour.firebasestorage.app",
  messagingSenderId: "764791659242",
  appId: "1:764791659242:web:f478ee64f1013067705593",
  measurementId: "G-3RYVGRSDX7"
};
    let db = null, tripRef = null, isRemoteUpdate = false;
    const urlParams = new URLSearchParams(window.location.search);
    let tripId = urlParams.get('id');
    
    if (!tripId) {
        tripId = 'trip_' + Math.random().toString(36).substr(2, 6);
        try {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + tripId;
            window.history.replaceState({path:newUrl},'',newUrl);
        } catch (e) { console.log("é è¦½ç’°å¢ƒç•¥éç¶²å€ä¿®æ”¹"); }
    }

    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        tripRef = dbRef(db, `trips/${tripId}`);
        console.log("Connected to Cloud (Multiplayer):", tripId);
    } else {
        console.log("Firebase Key not found. Using LocalStorage (Single Player).");
    }

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const weather = ref({ temp: null, icon: null });
            const syncStatus = ref('idle');
            
            const activeDay = ref(0);
            const tripDays = ref([{ events: [] }, { events: [] }, { events: [] }, { events: [] }]);
            
            // æ–°å¢ç¾é£Ÿèˆ‡ä¼´æ‰‹ç¦®æ¸…å–®
            const foodList = ref([]);
            const souvenirList = ref([]);

            const exchangeRate = ref(4.1);
            const lastRateUpdate = ref(''); 
            const isFetchingRate = ref(false); 

            const people = ref(['æˆ‘', 'æœ‹å‹']);
            const expenses = ref([]);
            
            const newExpense = ref({ 
                item: '', amount: '', payer: 'æˆ‘', splitType: 'even', involvedMembers: [], customAmounts: {} 
            });
            const newPersonName = ref('');

            // Sortable & Swipe
            const eventListRef = ref(null);
            let sortableInstance = null;
            const touchStartX = ref(0);
            const activeSwipeIndex = ref(-1); 
            const initialSwipeOffset = ref(0);

            const saveModeText = computed(() => db ? 'é›²ç«¯' : 'æœ¬æ©Ÿ');
            
            // å®‰å…¨è®€å– currentDay
            const currentDay = computed(() => tripDays.value[activeDay.value] || { events: [] });

            // å–å¾—ç•¶å‰é¡¯ç¤ºçš„åˆ—è¡¨ (ç”¨æ–¼ Swipe / Delete / Add)
            const currentList = computed(() => {
                if (currentTab.value === 'itinerary') return tripDays.value[activeDay.value].events;
                if (currentTab.value === 'food') return foodList.value;
                if (currentTab.value === 'souvenir') return souvenirList.value;
                return [];
            });

            // åŒ¯ç‡æŠ“å–åŠŸèƒ½
            const fetchExchangeRate = async () => {
                isFetchingRate.value = true;
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                    const data = await res.json();
                    if(data && data.rates && data.rates.TWD) {
                        exchangeRate.value = parseFloat(data.rates.TWD.toFixed(2));
                        const now = new Date();
                        lastRateUpdate.value = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                        updateData();
                        alert(`åŒ¯ç‡å·²æ›´æ–°ï¼ç›®å‰ 1 HKD â‰ˆ ${exchangeRate.value} TWD`);
                    } else { alert("ç„¡æ³•å–å¾—åŒ¯ç‡è³‡æ–™"); }
                } catch(e) { console.error(e); alert("åŒ¯ç‡æ›´æ–°å¤±æ•—"); } finally { isFetchingRate.value = false; }
            };

            const addMinutes = (timeStr, minsToAdd) => {
                if (!timeStr) return '';
                const [h, m] = timeStr.split(':').map(Number);
                const date = new Date(); date.setHours(h); date.setMinutes(m + minsToAdd);
                return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            };

            const autoAdjustTimes = () => {
                // æ™‚é–“èª¿æ•´åªåœ¨è¡Œç¨‹é é¢é‹ä½œ
                if (currentTab.value !== 'itinerary') return;

                const list = currentDay.value.events;
                if (list.length < 2) return;

                for (let i = 1; i < list.length; i++) {
                    const prev = list[i-1];
                    const curr = list[i];
                    let prevEndTime = (prev.type === 'flight') ? prev.arrTime : prev.time;
                    if (!prevEndTime) continue;
                    const minStartTime = addMinutes(prevEndTime, 30);
                    let currStartTime = (curr.type === 'flight') ? curr.depTime : curr.time;
                    if (currStartTime < minStartTime && curr.type !== 'flight') curr.time = minStartTime;
                }
            };

            const initSortable = () => {
                if (sortableInstance) sortableInstance.destroy();
                if (!eventListRef.value) return;
                
                sortableInstance = new Sortable(eventListRef.value, {
                    animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        if (evt.oldIndex === evt.newIndex) return;
                        
                        // æ ¹æ“šç•¶å‰ Tab æ±ºå®šæ“ä½œå“ªå€‹é™£åˆ—
                        let list;
                        if (currentTab.value === 'itinerary') list = tripDays.value[activeDay.value].events;
                        else if (currentTab.value === 'food') list = foodList.value;
                        else if (currentTab.value === 'souvenir') list = souvenirList.value;
                        else return;

                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                        
                        if (currentTab.value === 'itinerary') autoAdjustTimes();
                        updateData();
                    }
                });
            };

            // ç›£è½ Tab å’Œ Day åˆ‡æ›ä¾†é‡ç½® Sortable
            watch([activeDay, currentTab], () => { 
                activeSwipeIndex.value = -1;
                nextTick(initSortable); 
            });

            watch(people, (newPeople) => {
                if(newExpense.value.involvedMembers.length === 0) newExpense.value.involvedMembers = [...newPeople];
                newPeople.forEach(p => { if(!(p in newExpense.value.customAmounts)) newExpense.value.customAmounts[p] = 0; });
            }, { immediate: true });

            const customTotal = computed(() => {
                let sum = 0;
                for(let p in newExpense.value.customAmounts) sum += (newExpense.value.customAmounts[p] || 0);
                return sum;
            });

            // é€šç”¨ Swipe Handlers (é©ç”¨æ–¼æ‰€æœ‰åˆ—è¡¨)
            const touchStart = (e, idx) => {
                touchStartX.value = e.touches[0].clientX;
                const list = currentList.value;
                if (!list || !list[idx]) return;
                initialSwipeOffset.value = list[idx].swipeOffset || 0;
                if (activeSwipeIndex.value !== -1 && activeSwipeIndex.value !== idx) {
                   if (list[activeSwipeIndex.value]) list[activeSwipeIndex.value].swipeOffset = 0;
                   activeSwipeIndex.value = -1;
                }
            };

            const touchMove = (e, idx) => {
                const diff = e.touches[0].clientX - touchStartX.value;
                const list = currentList.value;
                if (!list || !list[idx]) return;
                let targetOffset = initialSwipeOffset.value + diff;
                if (targetOffset > 0) targetOffset = 0;
                if (targetOffset < -100) targetOffset = -100;
                list[idx].swipeOffset = targetOffset;
            };

            const touchEnd = (e, idx) => {
                const list = currentList.value;
                if (!list || !list[idx]) return;
                if (list[idx].swipeOffset < -40) {
                    list[idx].swipeOffset = -80; 
                    activeSwipeIndex.value = idx;
                } else {
                    list[idx].swipeOffset = 0;
                    if (activeSwipeIndex.value === idx) activeSwipeIndex.value = -1;
                }
            };

            onMounted(() => {
                if (db && tripRef) {
                    onValue(tripRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            isRemoteUpdate = true;
                            loadDataIntoVue(data);
                            setTimeout(() => isRemoteUpdate = false, 100);
                        }
                    });
                } else {
                    const localData = localStorage.getItem('hk_trip_' + tripId);
                    if (localData) loadDataIntoVue(JSON.parse(localData));
                    nextTick(initSortable);
                }
                fetchWeather();
            });

            const loadDataIntoVue = (data) => {
                const loadedDays = data.tripDays || [];
                while(loadedDays.length < 4) loadedDays.push({ events: [] });
                tripDays.value = loadedDays.slice(0, 4);
                
                expenses.value = data.expenses || [];
                exchangeRate.value = data.exchangeRate || 4.1;
                people.value = data.people || people.value;
                
                // è¼‰å…¥æ–°åˆ—è¡¨
                foodList.value = data.foodList || [];
                souvenirList.value = data.souvenirList || [];

                syncStatus.value = 'done';
                nextTick(initSortable);
            };

            const updateData = () => {
                if (isRemoteUpdate) return;
                syncStatus.value = 'syncing';
                const dataToSave = {
                    tripDays: JSON.parse(JSON.stringify(tripDays.value)),
                    expenses: JSON.parse(JSON.stringify(expenses.value)),
                    exchangeRate: exchangeRate.value,
                    people: people.value,
                    // å„²å­˜æ–°åˆ—è¡¨
                    foodList: JSON.parse(JSON.stringify(foodList.value)),
                    souvenirList: JSON.parse(JSON.stringify(souvenirList.value)),
                    lastUpdated: new Date().toISOString()
                };
                if (db && tripRef) set(tripRef, dataToSave).then(() => setTimeout(() => syncStatus.value = 'done', 500));
                else { localStorage.setItem('hk_trip_' + tripId, JSON.stringify(dataToSave)); setTimeout(() => syncStatus.value = 'done', 300); }
            };

            watch([tripDays, expenses, exchangeRate, people, foodList, souvenirList], () => { 
                if(isRemoteUpdate) return;
                clearTimeout(null); // Simple debounce placeholder
                syncStatus.value = 'syncing';
                setTimeout(updateData, 1000);
            }, { deep: true });

            const addDay = async () => { tripDays.value.push({ events: [] }); await nextTick(); activeDay.value = tripDays.value.length - 1; updateData(); };
            const removeDay = (index) => { if(tripDays.value.length <= 1) return; if(confirm('Delete?')) tripDays.value.splice(index, 1); updateData(); };

            const addEvent = () => { 
                const list = currentDay.value.events;
                let newTime = '10:00';
                if (list.length > 0) {
                    const last = list[list.length - 1];
                    const refTime = (last.type === 'flight') ? last.arrTime : last.time;
                    if (refTime) newTime = addMinutes(refTime, 30);
                }
                tripDays.value[activeDay.value].events.push({ type: 'event', time: newTime, title: '', isEditing: true, id: Date.now(), swipeOffset: 0 }); 
            };
            
            const addFlight = () => {
                const list = currentDay.value.events;
                let newDep = '10:00';
                if (list.length > 0) {
                    const last = list[list.length - 1];
                    const refTime = (last.type === 'flight') ? last.arrTime : last.time;
                    if (refTime) newDep = addMinutes(refTime, 60); 
                }
                tripDays.value[activeDay.value].events.push({ type: 'flight', depCode: '', depTime: newDep, arrCode: '', arrTime: addMinutes(newDep, 120), title: '', isEditing: true, id: Date.now(), swipeOffset: 0 });
                updateData();
            };

            // é€šç”¨æ–°å¢é …ç›® (ç¾é£Ÿ/ä¼´æ‰‹ç¦®)
            const addListItem = () => {
                const newItem = { title: '', note: '', isEditing: true, id: Date.now(), swipeOffset: 0 };
                if (currentTab.value === 'food') foodList.value.push(newItem);
                else if (currentTab.value === 'souvenir') souvenirList.value.push(newItem);
                updateData();
            };

            // é€šç”¨ç§»é™¤é …ç›®
            const removeItem = (idx) => {
                if (currentTab.value === 'itinerary') {
                    tripDays.value[activeDay.value].events.splice(idx, 1);
                    autoAdjustTimes();
                } else if (currentTab.value === 'food') {
                    foodList.value.splice(idx, 1);
                } else if (currentTab.value === 'souvenir') {
                    souvenirList.value.splice(idx, 1);
                }
                activeSwipeIndex.value = -1;
                updateData();
            };

            // ç§»é™¤ç‰¹å®šåŠŸèƒ½çš„ removeEvent wrapperï¼Œç›´æ¥ä½¿ç”¨ removeItem
            const removeEvent = removeItem;
            
            const addExpense = () => {
                const { item, amount, payer, splitType, involvedMembers, customAmounts } = newExpense.value;
                if(!item || !amount) return alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡");
                if(splitType === 'custom' && customTotal.value !== amount) return alert("é‡‘é¡ä¸ç¬¦");
                if(splitType === 'even' && involvedMembers.length === 0) return alert("è«‹é¸æ“‡æˆå“¡");
                
                expenses.value.unshift({ item, amount, payer, splitType, involvedMembers: [...involvedMembers], customAmounts: JSON.parse(JSON.stringify(customAmounts)) });
                newExpense.value.item = ''; newExpense.value.amount = '';
                people.value.forEach(p => newExpense.value.customAmounts[p] = 0);
                updateData();
            };

            const removeExpense = (i) => { expenses.value.splice(i, 1); updateData(); };

            const addPerson = () => {
                const name = newPersonName.value.trim();
                if (name && !people.value.includes(name)) { people.value.push(name); newPersonName.value = ''; updateData(); }
            };
            const removePerson = (index) => { if(confirm('Delete?')) { people.value.splice(index, 1); updateData(); } };

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (item.amount || 0), 0));
            const balances = computed(() => {
                let bal = {};
                people.value.forEach(p => bal[p] = { paid: 0, shouldPay: 0, balance: 0 });
                expenses.value.forEach(exp => {
                    const payer = exp.payer; const amount = exp.amount;
                    if(bal[payer]) bal[payer].paid += amount;
                    if (exp.splitType === 'custom') {
                        for (let person in exp.customAmounts) if(bal[person]) bal[person].shouldPay += (exp.customAmounts[person] || 0);
                    } else {
                        const involved = (exp.involvedMembers && exp.involvedMembers.length > 0) ? exp.involvedMembers : people.value;
                        const splitAmount = amount / involved.length;
                        involved.forEach(person => { if(bal[person]) bal[person].shouldPay += splitAmount; });
                    }
                });
                for(let p in bal) bal[p].balance = Math.round(bal[p].paid - bal[p].shouldPay);
                return bal;
            });
            const formatNumber = (num) => new Intl.NumberFormat().format(Math.round(num));

            const copyLink = () => { navigator.clipboard.writeText(window.location.href); alert("Copied ID: " + tripId); };

            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=22.31&longitude=114.16&current_weather=true');
                    const d = await res.json();
                    if(d.current_weather) {
                        weather.value.temp = Math.round(d.current_weather.temperature);
                        const c = d.current_weather.weathercode;
                        weather.value.icon = c <= 1 ? 'fas fa-sun text-yellow-400' : (c <= 60 ? 'fas fa-cloud text-slate-200' : 'fas fa-umbrella text-blue-400');
                    }
                } catch(e) {}
            };

            const switchTab = async (tab) => {
                currentTab.value = tab;
                if (tab === 'itinerary' || tab === 'food' || tab === 'souvenir') nextTick(initSortable);
            };

            return {
                tripId, currentTab, weather, activeDay, tripDays, expenses, exchangeRate, lastRateUpdate, isFetchingRate, people, newExpense, balances, totalExpense, syncStatus, saveModeText, customTotal, currentDay, currentList, foodList, souvenirList,
                currentTabName: computed(() => {
                    if (currentTab.value === 'itinerary') return 'Plan';
                    if (currentTab.value === 'wallet') return 'Wallet';
                    if (currentTab.value === 'food') return 'Food';
                    if (currentTab.value === 'souvenir') return 'Shop';
                }),
                addEvent, addFlight, removeEvent, addExpense, removeExpense, updateData, switchTab, copyLink, formatNumber, fetchExchangeRate,
                newPersonName, addPerson, removePerson, autoAdjustTimes, addListItem, removeItem,
                eventListRef, touchStart, touchMove, touchEnd 
            };
        }
    }).mount('#app');
</script>
</body>
</html>